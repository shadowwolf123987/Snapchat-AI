/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import state from"./state.js";import{getClosestElementBasedOnSelector,sendAnalytics,sendAnalyticsOnce,getElementBasedOnSelector,getArrayElementBasedOnSelector,createAcrobatIconElement,isOrphanContentScript,createURLForAttachment,LIST_VIEW}from"./util.js";import{createFteTooltip,shouldShowFteTooltip,updateFteToolTipCoolDown,acrobatTouchPointClicked,getAcrobatTouchPointFteEligibility,removeGsuiteFteTooltip}from"../gsuite/fte-utils.js";import{sendAnalyticsIfNativeViewerLaunched,processForNativeViewer}from"./native-viewer-touch-point-service.js";const ACROBAT_PROCESSED_ATTRIBUTE="acrobat-icon-added",LIST_VIEW_TOUCH_POINT_CLASS="acrobat-attachmentlistview-hyperlink",LIST_VIEW_TOUCH_POINT_VISIBLE="acrobat-gmail-attachment-visible",GMAIL_FTE_TOOLTIP_STORAGE_KEY="acrobat-gmail-fte-config",GMAIL_FTE_TOOLTIP_CONTAINER_CLASS="acrobat-fte-tooltip-container",revertAttachmentParentDivStyle=t=>{t?.style?.removeProperty("padding-right")},createAcrobatTooltip=()=>{const t=document.createElement("div");return t.setAttribute("class","acrobat-attachmentlistview-hyperlink-tooltip"),t.innerText=state?.gmailConfig?.acrobatPromptText,t},createAcrobatHyperlinkForListViewAttachment=(t,e)=>{const i=t.url,n=t.name,o=document.createElement("a");o.setAttribute("class",LIST_VIEW_TOUCH_POINT_CLASS);const a=createURLForAttachment(i,"GmailListView",n);o.setAttribute("href",a),o.setAttribute("target","_blank");let s=createAcrobatIconElement();return s.setAttribute("src",state?.iconURLListView),o.appendChild(s),o.addEventListener("click",(t=>{t.stopPropagation(),sendAnalytics([["DCBrowserExt:Gmail:ListViewPrompt:Clicked",{gsuiteFte:getAcrobatTouchPointFteEligibility(state?.gmailConfig?.enableGmailFteToolTip)}]]),removeFteTooltipFromAttachmentDiv(),acrobatTouchPointClicked("acrobat-gmail-fte-config"),document.removeEventListener("click",handleFteClickOutside),state.fteToolTip.lastGmailFteShown.type="",state.fteToolTip.touchPointClicked=!0})),o.addEventListener("mouseenter",(t=>{t?.target?.parentElement?.setAttribute("oldTitle",t?.target?.parentElement?.getAttribute("title")),t?.target?.parentElement?.setAttribute("title","")})),o.addEventListener("mouseleave",(t=>{t?.target?.parentElement?.setAttribute("title",t?.target?.parentElement?.getAttribute("oldTitle")),t?.target?.parentElement?.setAttribute("oldTitle","")})),o},getListViewPDFAttachmentsWithoutAcrobatIcon=(t,e)=>{if(!getElementBasedOnSelector(t,"pdfAttachmentWithoutAcrobatIcon","listView"))return;const i=getArrayElementBasedOnSelector(t,"pdfAttachmentWithoutAcrobatIcon","listView");let n={};if(i&&i.length>0)for(let t=0;t<i.length;t++){const o=getClosestElementBasedOnSelector(i[t],"threadElement","listView"),a=o.querySelector("[data-thread-id]");if(!a)return;const s=a.getAttribute("data-thread-id"),r=s?.substring(s?.indexOf("#")+1);isDataPresentForThreadId(r,e)&&(n[r]?n[r].pdfAttachments.push(i[t]):(n[r]={},n[r].pdfAttachments=[i[t]],n[r].threadElement=o))}return n},getSortedMessageIds=t=>{let e=Object.keys(t).sort(((e,i)=>-t[e].timestamp+t[i].timestamp));const i=e.filter((e=>t[e]?.deleted));return e=e.filter((e=>!t[e]?.deleted)),e.push(...i),e},getAttachmentURLAgainstName=(t,e)=>{const i={};let n=!1;for(let o=0;o<t.length;o++){const a=e[t[o]];if(a.attachments?.length>0)for(let t=0;t<a.attachments.length;t++){const e=a.attachments[t];i[e.name]?(n=!0,i[e.name].push(e)):i[e.name]=[e]}if(a.driveAttachments?.length>0)for(let t=0;t<a.driveAttachments.length;t++){const e=a.driveAttachments[t];i[e.name]?(n=!0,i[e.name].push(e)):i[e.name]=[e]}}return n&&sendAnalyticsOnce("DCBrowserExt:Gmail:SameNameAttachment"),i},isDataPresentForThreadId=(t,e)=>{let i=state.getMessagesForThreadId(t);return!i&&e&&e[t]&&(i=e[t].messages),!!i},getDataForThreadId=(t,e)=>{let i=state.getMessagesForThreadId(t);if(!i&&e&&e[t]&&(i=e[t].messages),i){let t=getSortedMessageIds(i);return getAttachmentURLAgainstName(t,i)}return null},isMultipleAttachmentWithSameName=(t,e)=>{const i=t[e];return i?.length>1},getAttachmentDetailsFromThreadData=(t,e,i)=>{const n=t[e];if(!n)return null;for(let t=0;t<n?.length;t++)if(!i.includes(n[t].url))return i.push(n[t].url),n[t]},addEventListenerToListViewPDFAttachment=t=>{t?.forEach((t=>{const e=getClosestElementBasedOnSelector(t,"attachmentDiv","listView");e&&(t.setAttribute("acrobat-icon-added","Y"),e.addEventListener("click",(()=>{sendAnalytics(["DCBrowserExt:Gmail:ListViewAttachment:Clicked"]),setTimeout((()=>{sendAnalyticsIfNativeViewerLaunched("Shown")}),500)}),{signal:state?.eventControllerSignal}))}))},makeTouchPointVisibleWhenAttachmentIsHovered=(t,e,i)=>{t.addEventListener("mouseenter",(()=>{isLargeLayout(i)&&!isOrphanContentScript()&&(e.style.display="flex",t.style.paddingRight="0")}),{signal:state.eventControllerSignal})},hideTouchPointWhenUserLeavesTheThread=(t,e,i)=>{i?.addEventListener("mouseleave",(()=>{isLargeLayout(t)&&(e.style.display="none",e.classList.contains(LIST_VIEW_TOUCH_POINT_VISIBLE)||i.style.removeProperty("padding-right"))}),{signal:state.eventControllerSignal})},removeTouchPointFromAttachmentDiv=t=>{const e=t?.getElementsByClassName(LIST_VIEW_TOUCH_POINT_CLASS);e?.length>0&&t.removeChild(e[0])},removeFteTooltipFromAttachmentDiv=()=>{const t=document.getElementsByClassName(LIST_VIEW_TOUCH_POINT_VISIBLE);if(t&&t[0]){const e=getClosestElementBasedOnSelector(t[0],"threadElement","listView");e&&e?.style?.removeProperty("z-index"),t[0].style.display="none",t[0].appendChild(createAcrobatTooltip()),t[0].parentElement.style.removeProperty("padding-right"),t[0].setAttribute("class",LIST_VIEW_TOUCH_POINT_CLASS)}removeFteToolTip()},removeFteToolTip=()=>{removeGsuiteFteTooltip(),state.fteToolTip.lastGmailFteShown={type:""}},handleFteClickOutside=(t,e)=>{document.getElementsByClassName("acrobat-fte-tooltip-container").length>0&&"listView"===state?.fteToolTip?.lastGmailFteShown?.type&&(e.contains(t.target)||(sendAnalytics(["DCBrowserExt:GmailFTE:ListView:Dismissed"]),document.removeEventListener("click",handleFteClickOutside))),removeFteTooltipFromAttachmentDiv()},addFteTooltipButtonEventListener=(t,e,i,n)=>{n.querySelector(".acrobat-fte-tooltip-button").addEventListener("click",(()=>{removeFteTooltipFromAttachmentDiv(),sendAnalytics(["DCBrowserExt:GmailFTE:ListView:Clicked"]),document.removeEventListener("click",handleFteClickOutside)}))},handleAcrobatTouchPointClickForFte=()=>{removeFteTooltipFromAttachmentDiv(),document.removeEventListener("click",handleFteClickOutside)},addFteTooltipToAttachmentDiv=(t,e,i)=>{let n="listView";isLastThreadInMail(t)&&(n="listViewLastThread");const o=createFteTooltip(state?.gmailConfig?.gmailFteToolTipStrings,n);addFteTooltipButtonEventListener(0,0,0,o),i.style.zIndex="5",e.addEventListener("click",(()=>handleAcrobatTouchPointClickForFte()),{once:!0}),document.addEventListener("click",(t=>handleFteClickOutside(t,o)),{once:!0,signal:state?.eventControllerSignal});const a=state?.gmailConfig?.gmailFteToolTipConfig?.tooltip;""===state?.fteToolTip?.lastGmailFteShown?.type&&(state.fteToolTip.lastGmailFteShown={type:"listView",href:window.location.href},sendAnalytics(["DCBrowserExt:GmailFTE:ListView:Shown"]),updateFteToolTipCoolDown(a,"acrobat-gmail-fte-config")),e.appendChild(o)},isLastThreadInMail=t=>{const e=t.getBoundingClientRect();return window.innerHeight-e.bottom<130},shouldShowListViewFte=(t,e)=>{if(document.getElementsByClassName("acrobat-fte-tooltip-container").length>0)return!1;const i=window.location.href;if(!isLargeLayout(e))return!1;const n=state?.fteToolTip?.lastGmailFteShown;return"listView"===n?.type?n?.href===i:(""===n?.type||"listView"===n?.type)&&t},addTouchPointToAttachmentDiv=(t,e,i)=>{const n=createAcrobatHyperlinkForListViewAttachment(e),o=state?.gmailConfig?.gmailFteToolTipConfig?.tooltip;shouldShowFteTooltip(o,state?.fteToolTip,"acrobat-gmail-fte-config").then((e=>{shouldShowListViewFte(e,i)?(t.style.paddingRight="0",n.classList.add(LIST_VIEW_TOUCH_POINT_VISIBLE),addFteTooltipToAttachmentDiv(t,n,i)):n.appendChild(createAcrobatTooltip()),makeTouchPointVisibleWhenAttachmentIsHovered(t,n,i),hideTouchPointWhenUserLeavesTheThread(i,n,t),t.appendChild(n)}))},addClickListenerToAttachmentDiv=(t,e)=>{t.addEventListener("click",(()=>{sendAnalytics(["DCBrowserExt:Gmail:ListViewPDFAttachment:Clicked"]),state.fteToolTip.lastGmailFteShown.type="nativeView",removeGsuiteFteTooltip(),document.removeEventListener("click",handleFteClickOutside),setTimeout((()=>processForNativeViewer(e,LIST_VIEW)),500),setTimeout((()=>processForNativeViewer(e,LIST_VIEW)),1e3)}),{signal:state?.eventControllerSignal})},addClickListenerToDriveAttachmentDiv=(t,e)=>{t.addEventListener("click",(()=>{sendAnalytics(["DCBrowserExt:Gmail:ListViewDrivePDFAttachment:Clicked"]),e&&!e?.isDriveAsset||setTimeout((()=>sendAnalyticsIfNativeViewerLaunched("DriveAttachment")),500)}),{signal:state?.eventControllerSignal})},processForAttachment=(t,e,i,n)=>{const o=getClosestElementBasedOnSelector(t,"attachmentDiv","listView");if(o){removeTouchPointFromAttachmentDiv(o),t.setAttribute("acrobat-icon-added","Y");const a=o.getAttribute("title"),s=isMultipleAttachmentWithSameName(e,a);let r=getAttachmentDetailsFromThreadData(e,a,i);if(s&&!r.url?.includes("showSameMailAttachmentToast")&&(r={...r,url:r.url+"&showSameMailAttachmentToast=true"}),r&&!r.isDriveAsset){const t=n.threadElement;addClickListenerToAttachmentDiv(o,r),addTouchPointToAttachmentDiv(o,r,t)}else addClickListenerToDriveAttachmentDiv(o,r)}},processForThread=(t,e,i)=>{const n=i.pdfAttachments,o=getDataForThreadId(t,e);if(!o)return;const a=[];for(let t of n)processForAttachment(t,o,a,i)},processForAllThreads=(t,e)=>{Object.keys(t).forEach((i=>{const n=t[i].pdfAttachments;if(n?.length>0){const n=t[i];processForThread(i,e,n)}}))},removeAllTouchPoints=()=>{const t=document.querySelectorAll(`.${LIST_VIEW_TOUCH_POINT_CLASS}`);if(t?.length>0)for(let e=0;e<t.length;e++)revertAttachmentParentDivStyle(t[e]?.parentElement),t[e]?.parentElement?.removeChild(t[e]);removeFteToolTip()},addAcrobatTouchPointInTheListView=(t,e)=>{const i=getListViewPDFAttachmentsWithoutAcrobatIcon(t);i&&processForAllThreads(i,e)},getListViewPDFAttachmentsWithoutAcrobatIconForClickListener=()=>getElementBasedOnSelector(document,"threadElement","listView")?getArrayElementBasedOnSelector(document,"pdfAttachmentWithoutAcrobatIcon","listView"):null,addEventListenersToListViewAttachments=()=>{const t=getListViewPDFAttachmentsWithoutAcrobatIconForClickListener();t&&addEventListenerToListViewPDFAttachment(t)},isLargeLayout=t=>t?.getBoundingClientRect()?.width>900,getVisibleListView=()=>{const t=getArrayElementBasedOnSelector(document,"listView","listView");for(let e=0;e<t?.length;e++)if("none"!==t[e].style?.display)return t[e];return null},processForListView=t=>{try{if(chrome?.runtime?.id)if(state?.gmailConfig?.enableListViewPromptInGmail||window.location?.search?.includes("enableAcrobatPromptInGmail")){const e=getVisibleListView();e&&addAcrobatTouchPointInTheListView(e,t)}else addEventListenersToListViewAttachments()}catch(t){sendAnalytics([["DCBrowserExt:Gmail:ListView:ProcessingError"]])}};export{processForListView,removeAllTouchPoints};